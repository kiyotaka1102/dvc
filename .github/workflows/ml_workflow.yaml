name: ML Workflow

on:
  push:
    branches: [ "main" ]
    paths:
      - '**.dvc'            
      - 'evaluate_only.py'
  pull_request:
    branches: [ "main" ]
    paths:
      - '**.dvc'
      - 'evaluate_only.py'

permissions: write-all

jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Setup DVC
        uses: iterative/setup-dvc@v1

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install "dvc[gs]" # Cáº§n cÃ i thÃªm thÆ° viá»‡n há»— trá»£ GCS

      - name: Pull Data from GCS
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          # Táº¡o file credential táº¡m thá»i cho mÃ¡y áº£o GitHub
          echo "$GCP_SA_KEY" > credentials.json
          dvc remote modify gcs-remote --local credentialpath credentials.json
          dvc pull
      # - name: Pull Data from Google Drive
      #   env:
      #     GDRIVE_CREDENTIALS_DATA: ${{ secrets.GDRIVE_CREDENTIALS_DATA }}
      #   run: |
      #     # Táº¡o file cáº¥u hÃ¬nh xÃ¡c thá»±c tá»« Secret
      #     mkdir -p .dvc/tmp
      #     echo "$GDRIVE_CREDENTIALS_DATA" > .dvc/tmp/gdrive-user-credentials.json
          
      #     # DVC tá»± Ä‘á»™ng dÃ¹ng file nÃ y Ä‘á»ƒ pull data
      #     dvc pull
      - name: Run Evaluation
        run: |
          python evaluate_only.py 

      - name: Create CML Report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ“Š Káº¿t quáº£ Ä‘Ã¡nh giÃ¡ tá»± Ä‘á»™ng (GCS Pipeline)" > report.md
          echo "### ðŸ”„ Metrics" >> report.md
          echo "\`\`\`" >> report.md
          cat metrics.txt >> report.md
          echo "\`\`\`" >> report.md
          
          echo "### ðŸ“ˆ Visualizations" >> report.md
          cml publish model_results.png --md >> report.md
          cml publish roc_curve.png --md >> report.md
          
          cml send-comment report.md